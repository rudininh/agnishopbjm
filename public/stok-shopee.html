<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - Stok Shopee</title>
    <link rel="stylesheet" href="./assets/style.css" />
</head>

<body>
    <div id="sidebar"></div>

    <div class="main-content">
        <div id="header"></div>

        <div class="dashboard-container">
            <div class="dashboard-card" id="stok-box">
                <h1>Stok Shopee</h1>
                <p>Daftar stok produk dari toko Shopee Anda.</p>

                <div class="status-box" style="overflow-x:auto;">
                    <table border="1" cellspacing="0" cellpadding="8" style="width:100%; border-collapse: collapse;">
                        <thead style="background:#f2f2f2;">
                            <tr>
                                <th>No</th>
                                <th>Nama Produk</th>
                                <th>SKU</th>
                                <th>Stok</th>
                                <th>Harga</th>
                            </tr>
                        </thead>
                        <tbody id="stok-table">
                            <tr>
                                <td colspan="5" style="text-align:center;">üîÑ Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="footer"></div>
    </div>

    <script>
        async function loadComponent(id, file) {
            try {
                const res = await fetch(file);
                if (!res.ok) throw new Error("Gagal load " + file);
                const html = await res.text();
                document.getElementById(id).innerHTML = html;
            } catch (err) {
                console.error("‚ùå Error load component:", file, err);
            }
        }

        loadComponent("sidebar", "./component/sidebar.html");
        loadComponent("header", "./component/header.html");
        loadComponent("footer", "./component/footer.html");

        if (!localStorage.getItem("loggedIn")) {
            window.location.href = "/";
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const tableBody = document.getElementById("stok-table");
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">üîÑ Mengambil data stok dari Shopee...</td></tr>`;

            try {
                // PENTING: gunakan path sesuai nama file go: /api/get_items
                const res = await fetch("/api/get_items");
                const text = await res.text();

                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    console.error("‚ùå Respons bukan JSON valid:", text);
                    tableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">‚ùå Respons tidak valid dari server.<br><small>${text.slice(0, 400)}</small></td></tr>`;
                    return;
                }

                if (!data.items || data.items.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">üì≠ Tidak ada data stok ditemukan</td></tr>`;
                    return;
                }

                let rows = "";
                data.items.forEach((item, i) => {
                    rows += `
            <tr>
              <td>${i + 1}</td>
              <td>${item.item_name || "-"}</td>
              <td>${item.item_sku || "-"}</td>
              <td>${item.stock ?? "-"}</td>
              <td>Rp${(item.price || 0).toLocaleString("id-ID")}</td>
            </tr>`;
                });
                tableBody.innerHTML = rows;

            } catch (err) {
                console.error("‚ùå Error ambil data stok:", err);
                tableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">‚ùå Gagal ambil data: ${err.message}</td></tr>`;
            }
        });
    </script>
</body>

</html>